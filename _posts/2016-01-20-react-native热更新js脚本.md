---
layout: post
title: react-native热更新js脚本
category: react-native
comments: true
---

说到版本更新，肯定离不开版本号，各家的版本号格式不同，意义也不一致，比较流行的版本号由3到4个数字组成，其中用.隔开，比如1.23.53、2.343.12.34，基于react-native开发产品，我个人觉得比较合理的版本号应该由4个数字组成，从左到右，第一位数字表示大版本号，当有重大更新时，该位数字加一，第二位数字是react-native的版本号，第三位数字表示发布的次数，发布正式版时，该位数字为偶数，发布测试版时，该位数字为奇数，在研发时，内部测试版和对外发布的正式版一定是有所区别的，那么我们通过判断该位的奇偶性就能很方便地区分对待了，最后一位数字表示了版本管理工具的版本号，比如我们目前使用svn来管理项目版本，每次提交时svn都有一个自增的版本号，将这个版本号记录在产品的版本号中，可以方便我们通过svn的log查询到对应的修改内容。

了解了版本号中各个数字的意义之后，那么我们接下来说说如何实现js代码的热更新。
[热更新的大致流程](https://www.processon.com/view/link/569f895ce4b0bd5c5c1062b6)如下：
![](http://upload-images.jianshu.io/upload_images/68795-c035e2064202c45f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

1.启动的时候使用原生语言判断本地是否存在曾经热更新下来的js代码，如果存在，那么加载该js代码，否则加载安装包asset中的js代码。这一步很好理解，发布产品的时候肯定有一份js代码是打包在asset中的，这是默认加载的js代码，假如我们已经成功通过热更新下载好了更新的js代码保存在本地，那么app启动的时候就应该直接加载保存在本地的js代码而不是asset中的旧代码了，否则每次启动都加载旧代码，那么热更新也就失去意义了。
2.js代码加载完成后就向服务器索要一份版本信息配置文件，其中记录了js代码压缩包的下载地址和版本号，也就是之前所说的第四位版本号，将该版本号与本地记录的js版本号进行比较，如果不一致，说明有新的js代码需要更新，如果一直，说明本地的js代码是最新的了，就直接进入主界面了。
3.根据版本信息配置文件中的下载地址下载js代码压缩包，为什么需要压缩？因为js代码太大了，目前我的js代码有1.2M左右，压缩一下就只有260K，可以加快用户的下载速度和节省用户的流量消耗，压缩包下载完成后开始解压，并将版本信息配置文件保存在本地。
4.js代码准备好了，那么接下来就是加载js代码了，如何加载？还记得开发时的“reload JS”按钮吗？查看react-native源码便可找到加载js代码的方法。
5.加载js完毕，又回到向服务器索要版本信息配置文件的步骤，不出意外的话，这次服务器端的版本号和本地的版本号是一致的，那么按照流程，就进入到了主界面，至此，整个热更新的流程也就结束了。

这就结束了吗？当然不是。试想，用户手机上的app和我们开发测试用的app如果共用一份服务器上的版本信息配置文件，那用户不就可以更新到不稳定的功能了吗？如何解决？很简单，使用版本号中第三位数字进行判断当前app是用户版还是测试版，再重申一次，版本号为偶数的便是用户使用的版本，版本号为奇数的便是开发测试使用的版本。在服务器上我们放置两个版本信息配置文件，分别提供给用户版和开发测试版使用，在js代码中，我们可以通过调用原生代码获取到版本号，判断奇偶性，然后从服务器端获取不同的版本信息配置文件，如此即可。

目前热更新只能实现js代码的更新，局限性比较大，当原生代码更新了或者图片资源更新了，还是需要重新打包，提供用户下载安装。

下面放上一个热更新实例图，新安装好的版本，主界面Toolbar右上角是没有“更多”按钮的，版本号的最后一位为1，重启启动后开始热更新，更新成功后，主界面Toolbar右上角出现“更多”按钮，版本号最后一位变成436。
![](http://upload-images.jianshu.io/upload_images/68795-d0acdd61c1158aae.gif?imageMogr2/auto-orient/strip)